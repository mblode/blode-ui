{
  "$schema": "https://ui.fingertip.com/schema/registry-item.json",
  "name": "multi-combobox",
  "author": "fingertip (https://ui.fingertip.com)",
  "dependencies": [
    "@fingertip/icons",
    "@radix-ui/react-popover",
    "downshift",
    "lodash"
  ],
  "registryDependencies": [
    "badge"
  ],
  "files": [
    {
      "path": "ui/multi-combobox.tsx",
      "content": "\"use client\";\nimport { ChevronDownIcon, CrossLargeIcon } from \"@fingertip/icons\";\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\";\nimport {\n  useCombobox,\n  useMultipleSelection,\n  UseMultipleSelectionStateChange,\n} from \"downshift\";\nimport lodashSnakeCase from \"lodash/snakeCase\";\nimport lodashUniqBy from \"lodash/uniqBy\";\nimport React, {\n  forwardRef,\n  useImperativeHandle,\n  useMemo,\n  useRef,\n  useState,\n} from \"react\";\n\nimport { cn } from \"@/lib/utils\";\n\nimport { Badge, BadgeProps } from \"./badge\";\nimport { ComboboxOption } from \"./combobox\";\n\nexport type MultiComboboxOption = ComboboxOption & {\n  variant?: BadgeProps[\"variant\"];\n};\n\nexport type OnMultiChangeParams =\n  | ((changes: UseMultipleSelectionStateChange<MultiComboboxOption>) => void)\n  | undefined;\nexport type MultiComboboxProps = {\n  options: MultiComboboxOption[];\n  values?: MultiComboboxOption[];\n  onChange?: OnMultiChangeParams;\n  onInputChange?: (value: string) => void;\n  maxDropdownHeight?: number;\n  startOpen?: boolean;\n  create?: boolean;\n  id?: string;\n  ref?: any;\n  placeholder?: string;\n  inputClassName?: string;\n  disabled?: boolean;\n};\n\nconst getFilteredOptions = (\n  options: MultiComboboxOption[],\n  selectedItems: MultiComboboxOption[],\n  inputValue: string,\n) => {\n  const lowerCasedInputValue = inputValue.toLowerCase();\n\n  return options.filter((option) => {\n    return (\n      !selectedItems.find(({ id }) => id === option.id) &&\n      (option?.label || \"\").toLowerCase().includes(lowerCasedInputValue)\n    );\n  });\n};\n\nexport const MultiCombobox: React.FC<MultiComboboxProps> = forwardRef(\n  (\n    {\n      options,\n      values,\n      onChange,\n      onInputChange,\n      startOpen,\n      placeholder = \"Filter\",\n      create = false,\n      id,\n      inputClassName,\n      disabled,\n    },\n    ref,\n  ) => {\n    values ??= [];\n    const [inputValue, setInputValue] = useState(\"\");\n    const [selectedItems, setSelectedItems] = useState(values);\n    const items = useMemo(\n      () => getFilteredOptions(options, selectedItems, inputValue),\n      [options, selectedItems, inputValue],\n    );\n    const {\n      getSelectedItemProps,\n      getDropdownProps,\n      removeSelectedItem,\n      addSelectedItem,\n    } = useMultipleSelection({\n      selectedItems,\n      // Handle removal\n      onStateChange(data) {\n        const { selectedItems: newSelectedItems, type } = data;\n        // For some reason we get multiple of the same option when selecting\n        // a predefined option.\n        const uniqueItems = lodashUniqBy(newSelectedItems, ({ id }) => id);\n        switch (type) {\n          case useMultipleSelection.stateChangeTypes\n            .SelectedItemKeyDownBackspace:\n          case useMultipleSelection.stateChangeTypes.SelectedItemKeyDownDelete:\n          case useMultipleSelection.stateChangeTypes.DropdownKeyDownBackspace:\n          case useMultipleSelection.stateChangeTypes.FunctionRemoveSelectedItem:\n          case useMultipleSelection.stateChangeTypes.FunctionAddSelectedItem:\n            setSelectedItems(uniqueItems);\n            break;\n          default:\n            break;\n        }\n        if (onChange) {\n          onChange({ selectedItems: uniqueItems, type });\n        }\n      },\n    });\n    const {\n      isOpen,\n      getToggleButtonProps,\n      getMenuProps,\n      getInputProps,\n      highlightedIndex,\n      getItemProps,\n      setInputValue: comboBoxSetInputValue,\n    } = useCombobox({\n      labelId: id,\n      items,\n      itemToString(item) {\n        return item?.label || \"\";\n      },\n      defaultHighlightedIndex: 0, // after selection, highlight the first item.\n      selectedItem: null,\n      initialIsOpen: startOpen,\n      onStateChange(changes) {\n        const localSelectedItems: MultiComboboxOption[] = selectedItems;\n        if (changes.selectedItem) {\n          localSelectedItems.push(changes.selectedItem);\n        }\n        switch (changes.type) {\n          case useCombobox.stateChangeTypes.InputKeyDownEnter:\n          case useCombobox.stateChangeTypes.ItemClick: {\n            if (changes.selectedItem) {\n              addSelectedItem(changes.selectedItem);\n            }\n            setInputValue(\"\");\n            if (onChange) {\n              onChange({\n                selectedItems: localSelectedItems,\n                type: useMultipleSelection.stateChangeTypes.SelectedItemClick,\n              });\n            }\n            break;\n          }\n          case useCombobox.stateChangeTypes.InputChange: {\n            setInputValue(\"\");\n            onInputChange?.(changes.inputValue || \"\");\n            break;\n          }\n          default:\n            break;\n        }\n      },\n    });\n\n    const handleCreate = () => {\n      if (!inputValue) {\n        return;\n      }\n      const newItem = {\n        id: lodashSnakeCase(inputValue),\n        label: inputValue,\n      };\n      addSelectedItem(newItem);\n      setInputValue(\"\");\n      comboBoxSetInputValue(\"\");\n    };\n\n    const comboboxRef = useRef<HTMLInputElement>(null);\n    const listboxRef = useRef<HTMLDivElement>(null);\n    const shouldCreate = create && inputValue;\n\n    const clearInput = () => {\n      comboBoxSetInputValue(\"\");\n    };\n\n    useImperativeHandle(ref, () => ({\n      clearInput,\n    }));\n\n    return (\n      <PopoverPrimitive.Root defaultOpen={startOpen} open={isOpen}>\n        <PopoverPrimitive.Anchor asChild>\n          <div\n            className={cn(\n              \"flex min-h-[52px] grow appearance-none rounded-2xl border border-input bg-card bg-clip-border text-base shadow-input hover:border-input-hover focus-within:border-ring focus-within:outline-hidden\",\n              inputClassName,\n            )}\n          >\n            <button\n              disabled={disabled}\n              aria-label=\"toggle menu\"\n              className=\"relative flex grow cursor-pointer bg-none px-3\"\n              type=\"button\"\n              {...getToggleButtonProps()}\n            >\n              <span className=\"flex min-h-[52px] grow flex-wrap items-center gap-2 bg-transparent py-1\">\n                {selectedItems.map(\n                  function renderSelectedItem(selectedItemForRender, index) {\n                    return (\n                      <Badge\n                        key={`selected-item-${index}`}\n                        {...getSelectedItemProps({\n                          selectedItem: selectedItemForRender,\n                          index,\n                        })}\n                        variant={selectedItemForRender?.variant}\n                      >\n                        {selectedItemForRender.label}\n                        <span\n                          className=\"cursor-pointer pl-1\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            removeSelectedItem(selectedItemForRender);\n                          }}\n                        >\n                          <CrossLargeIcon width={14} height={14} />\n                        </span>\n                      </Badge>\n                    );\n                  },\n                )}\n                <input\n                  data-testid=\"the-input\"\n                  disabled={disabled}\n                  className=\"grow bg-transparent outline-none border-none placeholder:text-placeholder-foreground\"\n                  placeholder={selectedItems.length === 0 ? placeholder : \"\"}\n                  {...getInputProps(\n                    getDropdownProps({ preventKeyAction: isOpen, id }),\n                  )}\n                  onClick={() => {}}\n                />\n              </span>\n\n              <div className=\"flex h-full items-center\">\n                <ChevronDownIcon\n                  className=\"size-4 opacity-50\"\n                  color=\"currentColor\"\n                />\n              </div>\n            </button>\n          </div>\n        </PopoverPrimitive.Anchor>\n\n        <PopoverPrimitive.Portal>\n          <PopoverPrimitive.Content\n            align=\"start\"\n            className=\"popover-content relative z-110 max-h-[250px] min-w-32 translate-y-1 overflow-hidden rounded-xl border border-border bg-popover text-popover-foreground shadow-soft animate-in fade-in-80\"\n            asChild\n            onOpenAutoFocus={(event) => event.preventDefault()}\n            onInteractOutside={(event) => {\n              const target = event.target as Element | null;\n              const isCombobox = target === comboboxRef.current;\n              const inListbox = target && listboxRef.current?.contains(target);\n              if (isCombobox || inListbox) {\n                event.preventDefault();\n              }\n            }}\n          >\n            <div\n              className=\"w-full overflow-y-auto p-1\"\n              {...getMenuProps({}, { suppressRefError: true })}\n            >\n              {shouldCreate && (\n                <div\n                  onClick={handleCreate}\n                  className=\"cursor-pointer px-4 py-2\"\n                >\n                  Create {inputValue}\n                </div>\n              )}\n\n              {isOpen &&\n                items.map((item, index) => (\n                  <div\n                    key={`${item.id}${index}`}\n                    className={cn(\"rounded-lg cursor-pointer px-4 py-2\", {\n                      \"bg-accent text-accent-foreground\":\n                        highlightedIndex === index,\n                    })}\n                    {...getItemProps({ item, index })}\n                  >\n                    {item.label}\n                  </div>\n                ))}\n\n              {items?.length === 0 && (\n                <div className=\"cursor-not-allowed px-4 py-3 text-center\">\n                  <div className=\"text-muted-foreground\">No results</div>\n                </div>\n              )}\n            </div>\n          </PopoverPrimitive.Content>\n        </PopoverPrimitive.Portal>\n      </PopoverPrimitive.Root>\n    );\n  },\n);\n",
      "type": "registry:ui",
      "target": ""
    }
  ],
  "type": "registry:ui"
}
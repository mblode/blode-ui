{
  "$schema": "https://ui.blode.co/schema/registry-item.json",
  "name": "multi-combobox",
  "title": "Multi Combobox",
  "author": "Matthew Blode",
  "description": "A combobox that allows selecting multiple items with tag-style badges.",
  "dependencies": [
    "@base-ui/react",
    "downshift",
    "lodash",
    "blode-icons-react"
  ],
  "registryDependencies": [
    "badge"
  ],
  "files": [
    {
      "path": "ui/multi-combobox.tsx",
      "content": "\"use client\";\n\nimport { ChevronDownIcon, CrossSmallIcon } from \"blode-icons-react\";\nimport {\n  type UseMultipleSelectionStateChange,\n  useCombobox,\n  useMultipleSelection,\n} from \"downshift\";\nimport snakeCase from \"lodash/snakeCase\";\nimport uniqBy from \"lodash/uniqBy\";\nimport * as React from \"react\";\n\nimport { cn } from \"@/lib/utils\";\nimport {\n  Popover,\n  PopoverAnchor,\n  PopoverContent,\n} from \"@/components/ui/popover\";\n\nimport { Badge, type BadgeProps } from \"./badge\";\n\nexport interface MultiComboboxOption {\n  description?: string;\n  id?: string | number;\n  label?: string;\n  variant?: BadgeProps[\"variant\"];\n}\n\nexport type OnMultiChangeParams = (\n  changes: UseMultipleSelectionStateChange<MultiComboboxOption>\n) => void;\n\nexport interface MultiComboboxProps {\n  create?: boolean;\n  disabled?: boolean;\n  id?: string;\n  inputClassName?: string;\n  maxDropdownHeight?: number;\n  onChange?: OnMultiChangeParams;\n  onInputChange?: (value: string) => void;\n  options: MultiComboboxOption[];\n  placeholder?: string;\n  startOpen?: boolean;\n  values?: MultiComboboxOption[];\n}\n\nexport interface MultiComboboxRef {\n  clearInput: () => void;\n}\n\nconst getFilteredOptions = (\n  options: MultiComboboxOption[],\n  selectedItems: MultiComboboxOption[],\n  inputValue: string\n) => {\n  const lowerCasedInputValue = inputValue.toLowerCase();\n\n  return options.filter((option) => {\n    return (\n      !selectedItems.find(({ id }) => id === option.id) &&\n      (option.label || \"\").toLowerCase().includes(lowerCasedInputValue)\n    );\n  });\n};\n\nconst MultiCombobox = React.forwardRef<MultiComboboxRef, MultiComboboxProps>(\n  (\n    {\n      options,\n      values,\n      onChange,\n      onInputChange,\n      startOpen,\n      placeholder = \"Filter\",\n      create = false,\n      id,\n      inputClassName,\n      disabled = false,\n      maxDropdownHeight = 250,\n    },\n    ref\n  ) => {\n    const [inputValue, setInputValue] = React.useState(\"\");\n    const [selectedItems, setSelectedItems] = React.useState(values ?? []);\n\n    React.useEffect(() => {\n      setSelectedItems(values ?? []);\n    }, [values]);\n\n    const items = React.useMemo(\n      () => getFilteredOptions(options, selectedItems, inputValue),\n      [options, selectedItems, inputValue]\n    );\n\n    const {\n      getSelectedItemProps,\n      getDropdownProps,\n      removeSelectedItem,\n      addSelectedItem,\n    } = useMultipleSelection({\n      selectedItems,\n      onStateChange(changes) {\n        const uniqueItems = uniqBy(changes.selectedItems ?? [], ({ id }) => id);\n\n        switch (changes.type) {\n          case useMultipleSelection.stateChangeTypes\n            .SelectedItemKeyDownBackspace:\n          case useMultipleSelection.stateChangeTypes.SelectedItemKeyDownDelete:\n          case useMultipleSelection.stateChangeTypes.DropdownKeyDownBackspace:\n          case useMultipleSelection.stateChangeTypes.FunctionRemoveSelectedItem:\n          case useMultipleSelection.stateChangeTypes.FunctionAddSelectedItem:\n            setSelectedItems(uniqueItems);\n            break;\n          default:\n            break;\n        }\n\n        onChange?.({\n          ...changes,\n          selectedItems: uniqueItems,\n        });\n      },\n    });\n\n    const {\n      isOpen,\n      getToggleButtonProps,\n      getMenuProps,\n      getInputProps,\n      highlightedIndex,\n      getItemProps,\n      setInputValue: comboboxSetInputValue,\n    } = useCombobox({\n      labelId: id,\n      items,\n      itemToString(item) {\n        return item?.label || \"\";\n      },\n      defaultHighlightedIndex: 0,\n      selectedItem: null,\n      initialIsOpen: startOpen,\n      onStateChange(changes) {\n        switch (changes.type) {\n          case useCombobox.stateChangeTypes.InputKeyDownEnter:\n          case useCombobox.stateChangeTypes.ItemClick:\n            if (changes.selectedItem) {\n              addSelectedItem(changes.selectedItem);\n            }\n            setInputValue(\"\");\n            comboboxSetInputValue(\"\");\n            break;\n          case useCombobox.stateChangeTypes.InputChange: {\n            const nextValue = changes.inputValue ?? \"\";\n            setInputValue(nextValue);\n            onInputChange?.(nextValue);\n            break;\n          }\n          default:\n            break;\n        }\n      },\n    });\n\n    const clearInput = React.useCallback(() => {\n      setInputValue(\"\");\n      comboboxSetInputValue(\"\");\n    }, [comboboxSetInputValue]);\n\n    React.useImperativeHandle(\n      ref,\n      () => ({\n        clearInput,\n      }),\n      [clearInput]\n    );\n\n    const handleCreate = () => {\n      const normalizedInput = inputValue.trim();\n      if (!normalizedInput) {\n        return;\n      }\n\n      addSelectedItem({\n        id: snakeCase(normalizedInput),\n        label: normalizedInput,\n      });\n\n      clearInput();\n    };\n\n    const shouldCreate = create && inputValue.trim().length > 0;\n\n    return (\n      <Popover defaultOpen={startOpen} open={isOpen}>\n        <PopoverAnchor asChild>\n          <div\n            className={cn(\n              \"flex min-h-[52px] grow appearance-none rounded-2xl border border-input bg-card bg-clip-border text-base shadow-input focus-within:border-ring focus-within:outline-hidden hover:border-input-hover\",\n              inputClassName\n            )}\n          >\n            <button\n              aria-label=\"toggle menu\"\n              className=\"relative flex grow cursor-pointer bg-none px-3\"\n              disabled={disabled}\n              type=\"button\"\n              {...getToggleButtonProps()}\n            >\n              <span className=\"flex min-h-[52px] grow flex-wrap items-center gap-2 bg-transparent py-1\">\n                {selectedItems.map((selectedItem, index) => (\n                  <Badge\n                    key={`${selectedItem.id}-${index}`}\n                    {...getSelectedItemProps({\n                      selectedItem,\n                      index,\n                    })}\n                    variant={selectedItem.variant}\n                  >\n                    {selectedItem.label}\n                    <span\n                      aria-label={`Remove ${selectedItem.label ?? \"item\"}`}\n                      className=\"cursor-pointer pl-1\"\n                      onClick={(event) => {\n                        event.stopPropagation();\n                        removeSelectedItem(selectedItem);\n                      }}\n                      onKeyDown={(event) => {\n                        if (event.key === \"Enter\" || event.key === \" \") {\n                          event.preventDefault();\n                          event.stopPropagation();\n                          removeSelectedItem(selectedItem);\n                        }\n                      }}\n                      role=\"button\"\n                      tabIndex={0}\n                    >\n                      <CrossSmallIcon className=\"size-3.5\" />\n                    </span>\n                  </Badge>\n                ))}\n                <input\n                  className=\"grow border-none bg-transparent outline-none placeholder:text-placeholder-foreground\"\n                  data-testid=\"multi-combobox-input\"\n                  disabled={disabled}\n                  placeholder={selectedItems.length === 0 ? placeholder : \"\"}\n                  {...getInputProps(\n                    getDropdownProps({ preventKeyAction: isOpen, id })\n                  )}\n                  onClick={(event) => {\n                    event.stopPropagation();\n                  }}\n                />\n              </span>\n              <div className=\"flex h-full items-center\">\n                <ChevronDownIcon\n                  className=\"size-4 opacity-50\"\n                  color=\"currentColor\"\n                />\n              </div>\n            </button>\n          </div>\n        </PopoverAnchor>\n\n        <PopoverContent\n          align=\"start\"\n          asChild\n          className=\"popover-content fade-in-80 relative z-110 w-auto min-w-32 translate-y-1 animate-in overflow-hidden rounded-xl border border-border bg-popover p-0 text-popover-foreground shadow-soft\"\n          onOpenAutoFocus={(event) => event.preventDefault()}\n          sideOffset={0}\n        >\n          <div\n            className=\"w-full overflow-y-auto p-1\"\n            style={{ maxHeight: maxDropdownHeight }}\n            {...getMenuProps({}, { suppressRefError: true })}\n          >\n            {shouldCreate ? (\n              <button\n                className=\"w-full cursor-pointer px-4 py-2 text-left\"\n                onClick={handleCreate}\n                type=\"button\"\n              >\n                Create {inputValue}\n              </button>\n            ) : null}\n\n            {isOpen &&\n              items.map((item, index) => (\n                <div\n                  className={cn(\"cursor-pointer rounded-lg px-4 py-2\", {\n                    \"bg-accent text-accent-foreground\":\n                      highlightedIndex === index,\n                  })}\n                  key={`${item.id}-${index}`}\n                  {...getItemProps({ item, index })}\n                >\n                  {item.label}\n                </div>\n              ))}\n\n            {items.length === 0 ? (\n              <div className=\"cursor-not-allowed px-4 py-3 text-center\">\n                <div className=\"text-muted-foreground\">No results</div>\n              </div>\n            ) : null}\n          </div>\n        </PopoverContent>\n      </Popover>\n    );\n  }\n);\n\nMultiCombobox.displayName = \"MultiCombobox\";\n\nexport { MultiCombobox };\n",
      "type": "registry:ui",
      "target": ""
    }
  ],
  "type": "registry:ui"
}